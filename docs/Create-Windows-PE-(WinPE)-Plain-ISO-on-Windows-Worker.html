
<!doctype html>
<html lang="en">




<head>
    <title>How to Create Windows PE (WinPE) Plain ISO on Windows Worker - Attune Automation</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="title"
          content="How to Create Windows PE (WinPE) Plain ISO on Windows Worker - Attune Automation">
    <meta name="description"
          content="">
    <meta name="robots"
          content="follow, index, max-snippet:-1, max-video-preview:-1, max-image-preview:large">

    <meta property="og:locale" content="en_AU" />
    <meta property="og:type" content="article" />
    <meta property="og:title"
          content="HowTo Create Windows PE (WinPE) Plain ISO on Windows Worker - Attune Automation" />
    <meta property="og:description" content="" />
    <meta property="og:site_name" content="Attune Automation" />
    <meta property="article:section" content="IT Instruction" />

    <meta name="twitter:title"
          content="How to Create Windows PE (WinPE) Plain ISO on Windows Worker - Attune Automation" />
    <meta name="twitter:description" content="" />

    <link rel="icon" href="https://www.servertribe.com/wp-content/uploads/2020/10/cropped-server_tribe_favicon-32x32.png" sizes="32x32">
    <link rel="icon" href="https://www.servertribe.com/wp-content/uploads/2020/10/cropped-server_tribe_favicon-192x192.png" sizes="192x192">
    <link rel="apple-touch-icon" href="https://www.servertribe.com/wp-content/uploads/2020/10/cropped-server_tribe_favicon-180x180.png">
    <meta name="msapplication-TileImage" content="https://www.servertribe.com/wp-content/uploads/2020/10/cropped-server_tribe_favicon-270x270.png">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
          crossorigin="anonymous">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <link rel="stylesheet" href="styles/style.css">

    <!-- Google tag (gtag.js) -->
    <script async
            src="https://www.googletagmanager.com/gtag/js?id=G-5TZQZNDJCD"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'G-5TZQZNDJCD');
    </script>
</head>


<body>

<!-- Project NavBar -->

<div class="bg-white border-bottom box-shadow sticky-top mb-3">
<div class="container px-0">
    <div class="row px-0">
        <div class="col d-flex flex-column flex-lg-row align-items-center px-0
            py-3">
            <a class="navbar-brand my-0 mr-lg-auto"
                  href="https://www.servertribe.com/"
                  target="_blank">
                    <img
                        src="https://www.servertribe.com/wp-content/uploads/2022/06/AttuneLogoV2_powered_by.png"
                        alt="Attune - Powered by ServerTribe"
                        class="img-fluid navbar-img">
            </a>
            <nav class="my-2 my-lg-0 mr-lg-3">
                <a class="p-2 text-dark" href="http://doc.servertribe.com/"
                   target="_blank">
                    Documentation
                </a>
                <a class="p-2 text-dark"
                   href="https://discord.com/invite/3YpJsagqUn"
                   target="_blank">
                    Discord
                </a>
                <a class="p-2 text-dark" href="https://github.com/Attune-Automation"
                   target="_blank">
                    GitHub
                </a>
                <a class="p-2 text-dark" href="https://www.servertribe.com/learn/"
                   target="_blank">
                    Learn
                </a>
            </nav>
            <a class="btn btn-outline-primary"
               href="https://www.servertribe.com/download-attune-registration/"
               target="_blank">
                Download NOW!
            </a>
        </div>
    </div>
</div></div>

<!-- Project breadcrumbs -->

<!-- Project breadcrumbs -->
<div class="container px-0">
    <div class="row">
        <nav class="col px-0" aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="index.html">
                    Automate Windows Installation with autounattend
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    <strong>Create Windows PE (WinPE) Plain ISO on Windows Worker</strong>
                </li>
            </ol>
        </nav>
    </div>
</div>

<!-- Blueprint Header -->

<div class="container px-0">
    <!-- Blueprint name and description -->
    <div class="row">
        <div class="col px-0">
            <h1 class="text-left">
                How to Create Windows PE (WinPE) Plain ISO on Windows Worker
            </h1>
        </div>
    </div>

<!-- Blueprint Description -->
    <div class="row pt-4">
        <div class="col-6 px-0">
            <h6 class="text-left">
                This documentation is generated by
                <a href="https://www.servertribe.com/"
                    class="badge badge-primary"
                    target="_blank">
                    Attune
                </a>
            </h6>
        </div>
        <div class="col-6 align-self-end text-right px-0">
            <h6 class="text-right">
                <a href="https://www.youtube.com/@servertribe"
                    class="badge badge-secondary"
                    target="_blank">
                    YouTube
                </a>
                <a href="https://github.com/Attune-Automation"
                    class="badge badge-secondary"
                    target="_blank">
                    GitHub
                </a>
                <a href="https://discord.com/invite/3YpJsagqUn"
                    class="badge badge-secondary"
                    target="_blank">
                    Discord
                </a>
                <a href="https://www.linkedin.com/company/servertribe/"
                    class="badge badge-secondary"
                    target="_blank">
                    LinkedIn
                </a>
                <a href="http://doc.servertribe.com/"
                    class="badge badge-secondary"
                    target="_blank">
                    Documentation
                </a>
            </h6>
        </div>
    </div>
    <hr>
</div>

<div class="documentation">
    <div class="container px-0">
        <div class="row">

<!-- Blueprint ToC -->


            <div class="toc col-lg-2 px-0 pr-5">
                <div class="container px-0 pt-3">
                    <p class="pb-2">
                        <strong>Contents</strong>
                    </p>
                    <p class="text-muted">
                        <a href="#top">
                            <strong>Create Windows PE (WinPE) Plain ISO on Windows Worker</strong>
                        </a>
                    </p>


    
        

                    <p class="text-muted pt-2">
                        <a href="#deletebuildwinpeisofolderonwindowsworker">
                            <strong>Step 1 -</strong> Delete build-winpe-iso Folder on Windows Worker
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#deploywin2019dvdisotobuildwinpeisoonwindowsworker">
                            <strong>Step 2 -</strong> Deploy Win2019 DVD ISO to build-winpe-iso on Windows Worker
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#extractwindowsbootimgfrombuildwinpeisoonwindowsworker">
                            <strong>Step 3 -</strong> Extract Windows boot.img from build-winpe-iso on Windows Worker
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#extractwinserverdvdisotowinimgonwindowsworker">
                            <strong>Step 4 -</strong> Extract Win Server DVD ISO to winimg on Windows Worker
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#extractwinpeisofromwinimgdirectoryonwindowsworker">
                            <strong>Step 5 -</strong> Extract WinPE ISO from winimg Directory on Windows Worker
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#extractwinpeisotostagingfolderonbuildwinpeisoonwindowsworker">
                            <strong>Step 6 -</strong> Extract WinPE ISO to Staging Folder on build-winpe-iso on Windows Worker
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#copyfilesformkwinpeimgcompatibilitytowinpestagingonwindowsworker">
                            <strong>Step 7 -</strong> Copy Files for mkwinpeimg Compatibility to WinPE Staging on Windows Worker
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#movebootimgtowinpestagingonwindowsworker">
                            <strong>Step 8 -</strong> Move boot.img to winpe_staging on Windows Worker
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#performdeletesetupexefromwinpestagingbootwimonwindowsworker">
                            <strong>Step 9 -</strong> Perform Delete setup.exe from winpe_staging boot.wim on Windows Worker
                        </a>
                    </p>
    
        

                    <p class="text-muted pt-2">
                        <a href="#createbootwimmountfolderinbuildwinpeisoonwindowsworker">
                            <strong>Step 9.1 -</strong> Create boot.wim Mount Folder in build-winpe-iso on Windows Worker
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#mountbootwiminbuildwinpeisoonwindowsworker">
                            <strong>Step 9.2 -</strong> Mount BOOT.WIM in build-winpe-iso on Windows Worker
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#deletesetupexefrombootwimonwindowsworker">
                            <strong>Step 9.3 -</strong> Delete setup.exe from boot.wim on Windows Worker
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#unmountbootwimfrombuildwinpeisoonwindowsworker">
                            <strong>Step 9.4 -</strong> Unmount boot.wim from build-winpe-iso on Windows Worker
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#overwritebootwimwithbootcleanedwimfrombuildwinpeisoonwindowsworker">
                            <strong>Step 9.5 -</strong> Overwrite BOOT.WIM with BOOT_CLEANED.WIM from build-winpe-iso on Windows Worker
                        </a>
                    </p>


        

                    <p class="text-muted pt-2">
                        <a href="#copywindowsefifilestowinpestagingonwindowsworker">
                            <strong>Step 10 -</strong> Copy Windows EFI Files to WinPE Staging on Windows Worker
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#copyefisysnopromptbinintoefisysbinonbuildwinpeisoonwindowsworker">
                            <strong>Step 11 -</strong> Copy efisys_noprompt.bin into efisys.bin on build-winpe-iso on Windows Worker
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#createwinpeplainbiosisofromwinpestagingonwindowsworker">
                            <strong>Step 12 -</strong> Create winpe_plain_bios.iso from winpe_staging on Windows Worker
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#deletebuildwinpeisofolderonwindowsworker">
                            <strong>Step 13 -</strong> Delete build-winpe-iso Folder on Windows Worker
                        </a>
                    </p>


                </div>
            </div>

<!-- Blueprint Contents -->
            <div class="col-lg-8 pt-3">
                <div class="container">


        <div class="jumbotron">
            <p class="display-3 text-center">
                <strong>Automate This</strong>
            </p>
            <p class="lead text-center">
                Use the <strong>Attune GUI</strong> for your Scripts
            </p>
            <p class="lead">
                <ol>
                    <a href="https://www.servertribe.com/download-attune-registration/"
                        target="_blank">
                        <span class="badge badge-primary">1</span>
                        Download Attune
                        <i class="fa-solid fa-download fa-beat-fade" style="color: #0197ff;"></i>
                    </a>
                </ol>
                <ol>
                    <a href="https://github.com/attune-Automation/"
                        target="_blank">
                        <span class="badge badge-primary">2</span>
                         Copy the Attune Project URL
                         <i class="fa-brands fa-github fa-fade"></i>
                    </a>
                </ol>
                <ol>
                    <a href="https://servertribe-attune.readthedocs.io/en/latest/howto/design_workspace/clone_project.html"
                        target="_blank">
                        <span class="badge badge-primary">3</span>
                        Clone the Project in Attune
                         <i class="fa-solid fa-book fa-fade" style="color: #0197ff;"></i>
                    </a>
                </ol>
                <ol>
                    <a href="https://www.youtube.com/watch?v=GCWDI29rDV0"
                        target="_blank">
                        <span class="badge badge-primary">4</span>
                        Plan your Job(s)
                        <i class="fa-brands fa-youtube fa-fade" style="color: #0197ff;"></i>
                    </a>
                </ol>
                <ol>
                    <a href="https://www.youtube.com/watch?v=b7DhFcURkZg"
                        target="_blank">
                        <span class="badge badge-primary">5</span>
                        Run your Job(s)
                        <i class="fa-brands fa-youtube fa-fade" style="color: #0197ff;"></i>
                    </a>
                </ol>
            </p>
            <p class="lead text-center">
                You've automated: <strong>Create Windows PE (WinPE) Plain ISO on Windows Worker</strong>
            </p>
            <hr class="my-4 text-center">
            <div class="col px-0">
                <p class="text-center">
                    Get the most out of automation with our get started
                    videos, product demonstrations, and more.
                </p>
                <p class="lead text-center">
                    <a class="btn btn-primary btn-lg"
                       href="https://www.servertribe.com/learn/"
                       target="_blank"
                       role="button">
                        Learn Attune Automation
                    </a>
                </p>
            </div>
        </div>

        <div class="row">
            <p>The following steps will guide you through the manual process.</p>
        </div>

<!-- Blueprint Steps -->


        



                    <div class="row pt-5">
                        <h3 id="deletebuildwinpeisofolderonwindowsworker">
                            <a href="#deletebuildwinpeisofolderonwindowsworker">
                                <strong>Step 1 -</strong> Delete build-winpe-iso Folder on Windows Worker
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Deletes the <code>C:\attuneautomationworker\build-winpe-iso</code> folder.</p>
                            </p>
                        </div>
                    </div>










                        <div class="row">
                            <p>
                                Connect via RDP:
                            </p>
                        </div>
                        <div class="row py-1">
                            <code class="language-sql">
mstsc /admin /v:{automationworkerwindowsnode}
                            </code>
                        </div>
                        <div class="row">
                            <p>
                                Login as user {automationworkerwindowsuseradministrator} and open a
                                command prompt.
                            </p>
                        </div>



    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$ISO_BUILD=&quot;C:\attuneautomationworker&quot;

if ( -Not (Test-Path &quot;${ISO_BUILD}&quot;) ) {
    Write-Host &quot;Directory ${ISO_BUILD} does not exist. Skipping.&quot;
} else {
    Set-Location &quot;${ISO_BUILD}&quot;
    
    $BUILD_FOLDER=&quot;build-winpe-iso&quot;
    
    if ( -Not (Test-Path &quot;${BUILD_FOLDER}&quot;) ) {
      Write-Host &quot;Directory ${ISO_BUILD}\${BUILD_FOLDER} does not exist. Skipping.&quot;
    } else {
      Remove-Item -Recurse &quot;${BUILD_FOLDER}&quot;
    }
}
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="deploywin2019dvdisotobuildwinpeisoonwindowsworker">
                            <a href="#deploywin2019dvdisotobuildwinpeisoonwindowsworker">
                                <strong>Step 2 -</strong> Deploy Win2019 DVD ISO to build-winpe-iso on Windows Worker
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                
                            </p>
                        </div>
                    </div>









    

    



    <div class="row">
        <p>
            <p>Download from https://www.microsoft.com/en-us/evalcenter/download-windows-server-2019.</p>
        </p>
        <p>
            Copy the File(s)
            <strong>Win201_ISO.tar</strong>
            to the target node.
        </p>
        <p>
            <strong>Deploy the File(s)</strong> here:
        </p>
    </div>
    <div class="row py-1">
        <code class="language-bash">
/c$/attuneautomationworker/build-winpe-iso
        </code>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="extractwindowsbootimgfrombuildwinpeisoonwindowsworker">
                            <a href="#extractwindowsbootimgfrombuildwinpeisoonwindowsworker">
                                <strong>Step 3 -</strong> Extract Windows boot.img from build-winpe-iso on Windows Worker
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
if (${{kickstartedBootLoaderIsBios}}) {

  $ISO_BUILD=&quot;C:\attuneautomationworker&quot;
  $BUILD_DIR=&quot;$ISO_BUILD\build-winpe-iso&quot;

  Set-Location $BUILD_DIR

  $scriptContent=@&#x27;
# Case insensitve globbing
shopt -s nocaseglob;
# Set the filename of the ISO
F=$(ls *.iso);
# Get the Boot image offset
OFFSET=`isoinfo -d -i $F | grep Bootoff | cut  -c21-`;
# Extract the boot.img.
dd if=$F of=boot.img bs=2048 count=8 skip=$OFFSET;
&#x27;@

  # Replace CRLF with LF
  $scriptContent = $scriptContent.replace(&quot;`r`n&quot;,&quot;`n&quot;)
  
  $FILE = &quot;attune_wsl_extract_boot_img.sh&quot;
  
  Set-Content -Path $FILE -NoNewline -Value $scriptContent

  wsl -d Ubuntu --user root --exec bash &quot;${FILE}&quot;

  if ($LASTEXITCODE -ne 0) {
      Write-Error &#x27;Failed to extract boot.img&#x27;
  }
  
  Remove-Item &quot;${FILE}&quot;
} else {
  Write-Host &quot;Skipping for UEFI ISO creation.&quot;
}
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="extractwinserverdvdisotowinimgonwindowsworker">
                            <a href="#extractwinserverdvdisotowinimgonwindowsworker">
                                <strong>Step 4 -</strong> Extract Win Server DVD ISO to winimg on Windows Worker
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Extracts the Windows Server ISO using <code>7z.exe</code> to <code>C:\attuneautomationworker\build-winpe-iso\winimg</code>.</p>
<p><code>winimg</code> stands for Windows Image.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$ISO_BUILD=&quot;C:\attuneautomationworker&quot;
$BUILD_DIR=&quot;$ISO_BUILD\build-winpe-iso&quot;

Set-Location $BUILD_DIR

$ISO_WILDCARD=&quot;*.iso&quot;
$FOLDER=&quot;winimg&quot;

if (test-Path &quot;${ISO_WILDCARD}&quot; -pathtype leaf) {
    $ISO=(dir $ISO_WILDCARD).name
    Write-Host &quot;Found ISO ${ISO}. Extracting it.&quot;
    
    &amp; &#x27;C:\Program Files\7-Zip\7z.exe&#x27; x &quot;.\${ISO}&quot; -o&quot;${FOLDER}&quot;
    
    Write-Host &quot;Removing ${ISO}&quot;
    Remove-Item &quot;${ISO}&quot;

} else {
	Write-Error &quot;No ISO found for extracting.&quot;
}
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="extractwinpeisofromwinimgdirectoryonwindowsworker">
                            <a href="#extractwinpeisofromwinimgdirectoryonwindowsworker">
                                <strong>Step 5 -</strong> Extract WinPE ISO from winimg Directory on Windows Worker
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Extracts the WinPE image from Windows Server 2019 <code>boot.wim</code> by default at index 2.</p>
<p>Writes this out to <code>winpe.iso</code>.</p>
<p>This is the exact copy of Windows Server 2019's WinPE image which by default will run <code>setup.exe</code> on the Windows Desktop ISO at a higher priority than running <code>startnet.cmd</code>.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$ISO_BUILD=&quot;C:\attuneautomationworker&quot;
$BUILD_DIR=&quot;$ISO_BUILD\build-winpe-iso&quot;

Set-Location $BUILD_DIR

  $scriptContent=@&#x27;
mkwinpeimg --iso --windows-dir=winimg &quot;winpe.iso&quot;
&#x27;@

# Replace CRLF with LF
$scriptContent = $scriptContent.replace(&quot;`r`n&quot;,&quot;`n&quot;)

$FILE = &quot;attune_wsl_extract_winpe_from_winimg_directory.sh&quot;

Set-Content -Path $FILE -NoNewline -Value $scriptContent

wsl -d Ubuntu --user root --exec bash &quot;${FILE}&quot;

if ($LASTEXITCODE -ne 0) {
    Write-Error &#x27;Failed to extract winpe.iso from winimg directory&#x27;
}

Remove-Item &quot;${FILE}&quot;
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="extractwinpeisotostagingfolderonbuildwinpeisoonwindowsworker">
                            <a href="#extractwinpeisotostagingfolderonbuildwinpeisoonwindowsworker">
                                <strong>Step 6 -</strong> Extract WinPE ISO to Staging Folder on build-winpe-iso on Windows Worker
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Extract <code>winpe.iso</code> to a <code>winpe_staging</code> folder on Windows Worker.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$ISO_BUILD=&quot;C:\attuneautomationworker&quot;
$BUILD_DIR=&quot;$ISO_BUILD\build-winpe-iso&quot;

Set-Location $BUILD_DIR

$FOLDER = &quot;winpe_staging&quot;

&amp; &#x27;C:\Program Files\7-Zip\7z.exe&#x27; x &quot;winpe.iso&quot; -o&quot;${FOLDER}&quot;
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="copyfilesformkwinpeimgcompatibilitytowinpestagingonwindowsworker">
                            <a href="#copyfilesformkwinpeimgcompatibilitytowinpestagingonwindowsworker">
                                <strong>Step 7 -</strong> Copy Files for mkwinpeimg Compatibility to WinPE Staging on Windows Worker
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>This copies <code>boot\etfsboot.com</code> from the Windows Server 2019 ISO to WinPE's <code>BOOT</code> folder.</p>
<p>This is needed if the WinPE ISO needs to work with future usages with <code>mkwinpeimg</code>.</p>
<p>Otherwise this step is not needed.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$ISO_BUILD=&quot;C:\attuneautomationworker&quot;
$BUILD_DIR=&quot;$ISO_BUILD\build-winpe-iso&quot;

Set-Location $BUILD_DIR

Copy-Item -Recurse `
    -Path &quot;.\winimg\boot\etfsboot.com&quot; `
    -Destination &quot;.\winpe_staging\BOOT&quot;
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="movebootimgtowinpestagingonwindowsworker">
                            <a href="#movebootimgtowinpestagingonwindowsworker">
                                <strong>Step 8 -</strong> Move boot.img to winpe_staging on Windows Worker
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Moves <code>boot.img</code> to the <code>winpe_staging</code> folder.</p>
<p><code>mkisofs</code> requires <code>boot.img</code> to make a BIOS bootable ISO.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
if (${{kickstartedBootLoaderIsBios}}) {
    $ISO_BUILD=&quot;C:\attuneautomationworker&quot;
    $BUILD_DIR=&quot;$ISO_BUILD\build-winpe-iso&quot;
    
    Set-Location $BUILD_DIR
    
    Move-Item -Path .\boot.img `
        -Destination .\winpe_staging
    
} else {
    Write-Host &quot;Skipping for UEFI ISO creation.&quot;
}
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="performdeletesetupexefromwinpestagingbootwimonwindowsworker">
                            <a href="#performdeletesetupexefromwinpestagingbootwimonwindowsworker">
                                <strong>Step 9 -</strong> Perform Delete setup.exe from winpe_staging boot.wim on Windows Worker
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                
                            </p>
                        </div>
                    </div>





    




    



                    <div class="row pt-5">
                        <h4 id="createbootwimmountfolderinbuildwinpeisoonwindowsworker">
                            <a href="#createbootwimmountfolderinbuildwinpeisoonwindowsworker">
                                <strong>Step 9.1 -</strong> Create boot.wim Mount Folder in build-winpe-iso on Windows Worker
                            </a>
                        </h4>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Creates a directory <code>WinPE_BootImageDir</code> for mounting <code>winpe_staging/SOURCES/BOOT.WIM</code>.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$ISO_BUILD=&quot;C:\attuneautomationworker&quot;
$BUILD_DIR=&quot;$ISO_BUILD\build-winpe-iso&quot;

Set-Location $BUILD_DIR

$WinPE_BootImageDir = &quot;WinPE_BootImageDir&quot;

if ( -Not (Test-Path &quot;${WinPE_BootImageDir}&quot;) ) {
    New-Item $WinPE_BootImageDir -ItemType Directory
}
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="mountbootwiminbuildwinpeisoonwindowsworker">
                            <a href="#mountbootwiminbuildwinpeisoonwindowsworker">
                                <strong>Step 9.2 -</strong> Mount BOOT.WIM in build-winpe-iso on Windows Worker
                            </a>
                        </h4>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Mounts <code>C:\attuneautomationworker\build-winpe-iso\winpe_staging\SOURCES\BOOT.WIM</code> to <code>C:\attuneautomationworker\build-winpe-iso\WinPE_BootImageDir</code> using <code>Dism</code> on Windows Worker.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$ISO_BUILD=&quot;C:\attuneautomationworker&quot;
$BUILD_DIR=&quot;$ISO_BUILD\build-winpe-iso&quot;

Set-Location $BUILD_DIR

Dism /Mount-Image /ImageFile:&quot;./winpe_staging/SOURCES/BOOT.WIM&quot; `
  /Index:1 `
  /MountDir:&quot;./WinPE_BootImageDir&quot;

if ($LASTEXITCODE -ne 0) {
    Write-Error &#x27;Failed to mount BOOT.WIM&#x27;
}
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="deletesetupexefrombootwimonwindowsworker">
                            <a href="#deletesetupexefrombootwimonwindowsworker">
                                <strong>Step 9.3 -</strong> Delete setup.exe from boot.wim on Windows Worker
                            </a>
                        </h4>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Deletes <code>setup.exe</code> from <code>C:\attuneautomationworker\build-winpe-iso\WinPE_BootImageDir</code>.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$ISO_BUILD=&quot;C:\attuneautomationworker&quot;
$WinPE_BootImageDir=&quot;$ISO_BUILD\build-winpe-iso\WinPE_BootImageDir&quot;

Set-Location $WinPE_BootImageDir

Remove-Item -Verbose .\setup.exe
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="unmountbootwimfrombuildwinpeisoonwindowsworker">
                            <a href="#unmountbootwimfrombuildwinpeisoonwindowsworker">
                                <strong>Step 9.4 -</strong> Unmount boot.wim from build-winpe-iso on Windows Worker
                            </a>
                        </h4>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Unmounts <code>C:\attuneautomationworker\build-winpe-iso\WinPE_BootImageDir</code> using <code>Dism</code>.</p>
<p>This will write out changes back into <code>C:\attuneautomationworker\winpe_staging\SOURCES\BOOT.WIM</code>.</p>
<p>Then a compressed version of <code>BOOT.WIM</code> is generated called <code>BOOT_CLEANED.WIM</code>.</p>
<p>Make sure there is no Windows File Explorer open at the mount directory.</p>
<p>If there is the unmount will fail and you need to run these commands to unmount it:</p>
<pre><code>$ISO_BUILD=&quot;C:\attuneautomationworker&quot;
$BUILD_DIR=&quot;$ISO_BUILD\build-winpe-iso&quot;

Set-Location $BUILD_DIR

Dism /Unmount-Image /MountDir:&quot;./WinPE_BootImageDir&quot; /discard
</code></pre>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$ISO_BUILD=&quot;C:\attuneautomationworker&quot;
$BUILD_DIR=&quot;$ISO_BUILD\build-winpe-iso&quot;

Set-Location $BUILD_DIR

Dism /Image:&quot;./WinPE_BootImageDir&quot; `
    /cleanup-image `
    /StartComponentCleanup `
    /ResetBase
    
# Unmount the WinPE_BootImageDir folder back into BOOT.WIM
Dism /Unmount-Image /MountDir:&quot;./WinPE_BootImageDir&quot; /Commit

# Generate a compressed version of BOOT.WIM called BOOT_CLEANED.WIM
Dism /Export-Image /SourceImageFile:&quot;./winpe_staging/SOURCES/BOOT.WIM&quot; `
  /SourceIndex:1 `
  /DestinationImageFile:&quot;./winpe_staging/SOURCES/BOOT_CLEANED.WIM&quot; `
  /Compress:max `
  /Bootable `
  /CheckIntegrity
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="overwritebootwimwithbootcleanedwimfrombuildwinpeisoonwindowsworker">
                            <a href="#overwritebootwimwithbootcleanedwimfrombuildwinpeisoonwindowsworker">
                                <strong>Step 9.5 -</strong> Overwrite BOOT.WIM with BOOT_CLEANED.WIM from build-winpe-iso on Windows Worker
                            </a>
                        </h4>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Overwrites <code>BOOT.WIM</code> with <code>BOOT_CLEANED.WIM</code> and deletes <code>BOOT_CLEANED.WIM</code>.</p>
<p>This is relative to the <code>C:\attuneautomationworker\build-winpe-iso\winpe_staging\SOURCES</code> folder.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$ISO_BUILD=&quot;C:\attuneautomationworker&quot;
$WINPE_STAGING_SOURCES_DIR=&quot;$ISO_BUILD\build-winpe-iso\winpe_staging\SOURCES&quot;

Set-Location &quot;${WINPE_STAGING_SOURCES_DIR}&quot;

Write-Host &quot;Before&quot;
dir

$BOOT_CLEANED_WIM=&quot;BOOT_CLEANED.WIM&quot;

Copy-Item -Path &quot;.\${BOOT_CLEANED_WIM}&quot; `
    -Destination &quot;.\BOOT.WIM&quot;
    
Remove-Item &quot;.\${BOOT_CLEANED_WIM}&quot;

Write-Host &quot;After&quot;
dir
                </code>
            </pre>
        </div>
    </div>






        



                    <div class="row pt-5">
                        <h3 id="copywindowsefifilestowinpestagingonwindowsworker">
                            <a href="#copywindowsefifilestowinpestagingonwindowsworker">
                                <strong>Step 10 -</strong> Copy Windows EFI Files to WinPE Staging on Windows Worker
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Relative to the <code>C:\attuneautomationworker\build-winpe-iso\winpe</code> directory, copies the EFI files in <code>winimg\efi</code>to <code>winpe_staging</code>.</p>
<p>The <code>efi</code> folder is also copied.</p>
<p>Only applies to UEFI kickstarts so only if <code>kickstartedBootLoaderIsUefi</code> is set to the string <code>true</code>.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
if (${{kickstartedBootLoaderIsUefi}}) {
    
    $ISO_BUILD=&quot;C:\attuneautomationworker&quot;
    $BUILD_DIR=&quot;$ISO_BUILD\build-winpe-iso&quot;

    Set-Location $BUILD_DIR
    
    # Copy EFI Files from Windows ISO
    Copy-Item -Recurse -Path &quot;.\winimg\efi&quot; `
        -Destination &quot;.\winpe_staging&quot;
    
} else {
    echo &quot;Skipping for BIOS ISO creation.&quot;
}
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="copyefisysnopromptbinintoefisysbinonbuildwinpeisoonwindowsworker">
                            <a href="#copyefisysnopromptbinintoefisysbinonbuildwinpeisoonwindowsworker">
                                <strong>Step 11 -</strong> Copy efisys_noprompt.bin into efisys.bin on build-winpe-iso on Windows Worker
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
if ( ${{kickstartedBootLoaderIsUefi}} ) {

    $ISO_BUILD=&quot;C:\attuneautomationworker&quot;
    $BUILD_DIR=&quot;$ISO_BUILD\build-winpe-iso&quot;

    Set-Location $BUILD_DIR

    Set-Location winpe_staging\efi\microsoft\boot
    
    Write-Host &quot;Before hashes of efisys.bin and efisys_noprompt.bin&quot;
    Get-FileHash .\efisys.bin
    Get-FileHash .\efisys_noprompt.bin
    
    Copy-Item -Path .\efisys_noprompt.bin -Destination .\efisys.bin
    
    Write-Host &quot;After hashes of efisys.bin and efisys_noprompt.bi&quot;
    Get-FileHash .\efisys.bin
    Get-FileHash .\efisys_noprompt.bin
    
} else {
    Write-Host &quot;Skipping for BIOS ISO creation.&quot;
}
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="createwinpeplainbiosisofromwinpestagingonwindowsworker">
                            <a href="#createwinpeplainbiosisofromwinpestagingonwindowsworker">
                                <strong>Step 12 -</strong> Create winpe_plain_bios.iso from winpe_staging on Windows Worker
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Creates a WinPE BIOS bootable ISO at <code>C:\attuneautomationworker\winpe_plain_bios.iso</code> from the WinPE staging directory <code>C:\attuneautomationworker\build-winpe-iso\winpe_staging</code>. </p>
<p>Only applies to UEFI kickstarts. Only run if the parameter <code>kickstartedBootLoaderIsBios</code> is set <code>true</code>.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
if (${{kickstartedBootLoaderIsBios}}) {
    $ISO_BUILD=&quot;C:\attuneautomationworker&quot;
    $BUILD_DIR=&quot;$ISO_BUILD\build-winpe-iso&quot;
    
    Set-Location $BUILD_DIR

    $ISO_NAME=&quot;winpe_plain_bios.iso&quot;

    $scriptContent=@&quot;
mkisofs \
    -b boot.img \
    -no-emul-boot \
    -c BOOT.CAT \
    -iso-level 3 \
    -udf \
    -joliet-long \
    -relaxed-filenames \
    -allow-limited-size \
    -J \
    -full-iso9660-filenames \
    -disable-deep-relocation \
    -omit-version-number \
    -V &quot;KS_WIN&quot; \
    -o &quot;../${ISO_NAME}&quot; \
    winpe_staging
&quot;@

  # Replace CRLF with LF
  $scriptContent = $scriptContent.replace(&quot;`r`n&quot;,&quot;`n&quot;)

  $FILE = &quot;attune_wsl_create_winpe_plain_bios_iso.sh&quot;

  Set-Content -Path $FILE -NoNewline -Value $scriptContent

  wsl -d Ubuntu --user root --exec bash &quot;${FILE}&quot;

  if ($LASTEXITCODE -ne 0) {
      Write-Error &#x27;Failed to extract boot.img&#x27;
  }

  Remove-Item &quot;${FILE}&quot;
} else {
  Write-Host &quot;Skipping for UEFI ISO creation.&quot;
}
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="deletebuildwinpeisofolderonwindowsworker">
                            <a href="#deletebuildwinpeisofolderonwindowsworker">
                                <strong>Step 13 -</strong> Delete build-winpe-iso Folder on Windows Worker
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Deletes the <code>C:\attuneautomationworker\build-winpe-iso</code> folder.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$ISO_BUILD=&quot;C:\attuneautomationworker&quot;

if ( -Not (Test-Path &quot;${ISO_BUILD}&quot;) ) {
    Write-Host &quot;Directory ${ISO_BUILD} does not exist. Skipping.&quot;
} else {
    Set-Location &quot;${ISO_BUILD}&quot;
    
    $BUILD_FOLDER=&quot;build-winpe-iso&quot;
    
    if ( -Not (Test-Path &quot;${BUILD_FOLDER}&quot;) ) {
      Write-Host &quot;Directory ${ISO_BUILD}\${BUILD_FOLDER} does not exist. Skipping.&quot;
    } else {
      Remove-Item -Recurse &quot;${BUILD_FOLDER}&quot;
    }
}
                </code>
            </pre>
        </div>
    </div>






                    <div class="row pt-5">
                        <div class="col">
                            <h2>Completed</h2>
                            <p>
                                You have completed this instruction.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

<!-- Download Attune Ad -->

            <div class="toc col-lg-2 px-0">
                <div class="container px-0 pt-3 pl-5">
                    <div class="card border-light mb-3" style="max-width: 18rem;">
                        <div class="card-body attune-ad">
                            <img
                                src="https://www.servertribe.com/wp-content/uploads/2022/06/AttuneLogoV2_powered_by.png"
                                alt="Attune - Powered by ServerTribe"
                                class="img-fluid">
                            <p class="card-title mt-3 text-center">
                                <strong>Automate with Attune</strong>
                            </p>
                            <p class="card-text text-center">
                                Download the Attune Community Edition.
                            </p>
                            <p class="text-center">
                                <a href="https://www.servertribe.com/download-attune-registration/"
                                   class="btn btn-primary mt-3">
                                    DOWNLOAD!!!
                                </a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

        </div>

<!-- Join Discord -->

        <div class="row py-5">
            <div class="jumbotron">
              <h1 class="display-4 text-center">
                  Discuss this Project in Discord
              </h1>
              <p class="lead">

                  Join our Discord channel and connect with like-minded individuals who
                  share your passion. Engage in lively discussions, gain valuable insights,
                  and stay updated on the latest trends in our industry. Don't miss out on
                  this opportunity to network, learn, and grow together.
              </p>
              <hr class="my-4 text-center">
                <div class="col px-0">
                  <p class="text-center">
                      Click the link below and become a part of our vibrant community on
                      Discord today!
                  </p>
                  <p class="lead text-center">
                    <a class="btn btn-primary btn-lg"
                       href="https://discord.com/invite/3YpJsagqUn"
                       role="button">
                        Join NOW!!!
                    </a>
                  </p>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Project Footer -->

<footer class="footer fixed-bottom bg-white border-top box-shadow">
      <div class="container px-0">
          <div class="row">
              <div class="col px-0">
                  <a class="my-0 mr-lg-auto"
                     href="https://www.servertribe.com/"
                     target="_blank">
                      <img
                          src="https://www.servertribe.com/wp-content/uploads/2022/06/AttuneLogoV2_powered_by.png"
                          alt="Attune - Powered by ServerTribe"
                          class="img-fluid navbar-img">
                  </a>
              </div>
          </div>
      </div>
</footer>


<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
<script
    src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
<script
    src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>

<script
    src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

<script
    src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script
    src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>


</body>
</html>
