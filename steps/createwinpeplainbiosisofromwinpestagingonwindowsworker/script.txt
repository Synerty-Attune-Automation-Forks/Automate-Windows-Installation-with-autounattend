if (${{kickstartedBootLoaderIsBios}}) {
    $ISO_BUILD="C:\attuneautomationworker"
    $BUILD_DIR="$ISO_BUILD\build-winpe-iso"
    
    Set-Location $BUILD_DIR

    $ISO_NAME="winpe_plain_bios.iso"

    $scriptContent=@"
mkisofs \
    -b boot.img \
    -no-emul-boot \
    -c BOOT.CAT \
    -iso-level 3 \
    -udf \
    -joliet-long \
    -relaxed-filenames \
    -allow-limited-size \
    -J \
    -full-iso9660-filenames \
    -disable-deep-relocation \
    -omit-version-number \
    -V "KS_WIN" \
    -o "../${ISO_NAME}" \
    winpe_staging
"@

  # Replace CRLF with LF
  $scriptContent = $scriptContent.replace("`r`n","`n")

  $FILE = "attune_wsl_create_winpe_plain_bios_iso.sh"

  Set-Content -Path $FILE -NoNewline -Value $scriptContent

  wsl -d Ubuntu --user {wsl2AutomationWorkerLinuxUser.user} --exec bash "${FILE}"

  if ($LASTEXITCODE -ne 0) {
      Write-Error 'Failed to extract boot.img'
  }

  Remove-Item "${FILE}"
} else {
  Write-Host "Skipping for UEFI ISO creation."
}